<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link type="text/css" rel="stylesheet" href="/static/css/main.css">
    <title>语音天气</title>
</head>
<body>
<div id="topic">
    <!--        <img src="/static/img/logo.png">-->
    <div><h1>语音天气</h1></div>
    <div id="cen"><h2>语音识别出得城市为:</h2></div>
    <div id="city"><h2 id="city-1"></h2></div>
    <div id="rig"><h1>{{data}}</h1></div>
</div>
{% if seter %}
<div class="tab">
    <table>
        <tr>
            <td>城市:</td>
            <td>{{seter[0]}}</td>
        </tr>
        <tr>
            <td>日期:</td>
            <td>{{seter[1]}}</td>
        </tr>
        <tr>
            <td>天气:</td>
            <td>{{seter[2]}}</td>
        </tr>
        <tr>
            <td>风力等级:</td>
            <td>{{seter[3]}}</td>
        </tr>
        <tr>
            <td>温度:</td>
            <td>{{seter[4]}}</td>
        </tr>
        <tr>
            <td>空气质量:</td>
            <td>{{seter[5]}}</td>
        </tr>
    </table>
</div>
{% else %}
<div class="tab">
    <table>
        <tr>
            <td >城市:</td>
            <td id="tr1"></td>
        </tr>
        <tr>
            <td>日期:</td>
            <td id="tr2"></td>
        </tr>
        <tr>
            <td>天气:</td>
            <td id="tr3"></td>
        </tr>
        <tr>
            <td>风力等级:</td>
            <td id="tr4"></td>
        </tr>
        <tr>
            <td>温度:</td>
            <td id="tr5"></td>
        </tr>
        <tr>
            <td>空气质量:</td>
            <td id="tr6"></td>
        </tr>
    </table>
</div>
{% endif %}
<div id="play">
    <audio autoplay="autoplay"
           controls id="play_mp3"
           src="">
        浏览器不支持
    </audio>
    <div id="btn1">
        <button onclick="start_reco()">开始录音</button>
    </div>
    <div id="btn2">
        <button onclick="stop_reco()">结束录音</button>
    </div>
    <!--<div id="btn3">-->
        <!--<button onclick="checkUsername()">显示文字天气</button>-->
    <!--</div>-->
</div>
</body>
<script type="text/javascript" src="/static/Recorder.js"></script>
<script type="text/javascript">
    //建立 websocket 连接
    var ws = new WebSocket('ws://127.0.0.1:5000/upload');
    // ws.onopen = function () {
    //     ws.send("hello")
    // };

    // 如何录音
    var reco = null;
    // 创建一个录音audiocontext对象
    var audio_context = new AudioContext();
    // 解决浏览器的兼容问题
    navigator.getUserMedia = (navigator.getUserMedia ||
    navigator.webkitGetUserMedia ||
    navigator.mozGetUserMedia ||
    navigator.msGetUserMedia);

    navigator.getUserMedia({audio:true},create_stream,function (err) {
        console.log(err)
    });

    function create_stream(stream) {
        var stream_input = audio_context.createMediaStreamSource(stream);
        reco = new Recorder(stream_input)
    }
    // 开始录音
    function start_reco() {
        reco.record();
    }
    // 结束录音
    function stop_reco() {
        reco.stop();
        get_audio();
        reco.clear();
    }
    // 向后端发送录制的音频
    function get_audio() {
        reco.exportWAV(function (wav_file) {
            ws.send(wav_file)
        })
    }

    function rload(){
        window.location.reload();
    }
    // 接收后端发送的信息，触发回调函数
    ws.onmessage = function (ev) {
        // 从ev.data中获取参数
        var data = JSON.parse(ev.data);
        document.getElementById("play_mp3").src = "http://127.0.0.1:5000/getfile/"+data.filename;
        checkUsername();
    }


 var httpRequest;
    function checkUsername() {

        if(window.XMLHttpRequest) {

            //在IE6以上的版本以及其他内核的浏览器(Mozilla)等
            httpRequest = new XMLHttpRequest();
        }else if(window.ActiveXObject) {

            //在IE6以下的版本
            httpRequest = new ActiveXObject();
        }


        //创建http请求
        httpRequest.open("GET", "http://127.0.0.1:5000/info", true);


        //指定回调函数
        httpRequest.onreadystatechange = response22;



        //发送http请求，把要检测的用户名传递进去
        httpRequest.send();

    }

    function response22() {

        //判断请求状态码是否是4【数据接收完成】
        if(httpRequest.readyState==4) {

            //再判断状态码是否为200【200是成功的】
            if(httpRequest.status==200) {

                //得到服务端返回的文本数据
                var text = httpRequest.responseText;
                jsondata = JSON.parse(text)
                //把服务端返回的数据写在div上
                document.getElementById("city-1").innerText=jsondata.city;
                document.getElementById("tr1").innerText=jsondata.city;
                document.getElementById("tr2").innerText=jsondata.today;
                document.getElementById("tr3").innerText=jsondata.weather;
                document.getElementById("tr4").innerText=jsondata.wdforce;
                document.getElementById("tr5").innerText=jsondata.temp;
                document.getElementById("tr6").innerText=jsondata.pm25;
            }

        }
    }


</script>
</html>
